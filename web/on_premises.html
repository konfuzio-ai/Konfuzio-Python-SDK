<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta content="Documentation on how to deploy Konfuzio on premises using Kubernetes and Helm." name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>On-Premises Documentation &mdash; Konfuzio  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/full_green_square.png"/>
    <link rel="canonical" href="https://dev.konfuzio.com/web/on_premises.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Changelog" href="changelog_app.html" />
    <link rel="prev" title="Frontend" href="frontend/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Konfuzio
            <img src="../_static/docs__static_square_transparent_super_small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Konfuzio SDK</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sdk/configuration_reference.html">Install SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk/sourcecode.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk/sourcecode.html#tokenizer">Tokenizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk/sourcecode.html#document-categorization">Document Categorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk/sourcecode.html#ai-evaluation">AI Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk/examples/examples.html">Code Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk/contribution.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk/coordinates_system.html">Coordinates System</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Konfuzio Server</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="api.html">REST API v2</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-v3.html">REST API v3</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontend/index.html">Frontend</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">On-Premises Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#kubernetes">Kubernetes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#required-tools">Required tools</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#kubectl">kubectl</a></li>
<li class="toctree-l4"><a class="reference internal" href="#helm">Helm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#next-steps">Next steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#deployment">Deployment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#selecting-configuration-options">Selecting configuration options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-using-helm">Deploy using Helm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#monitoring-the-deployment">Monitoring the Deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initial-login">Initial login</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#upgrade">Upgrade</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#docker">Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#single-vm-setup">Single VM setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#download-docker-image">1. Download Docker Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setup-postgresql-redis-blobstorage-filesystemstorage">2. Setup PostgreSQL, Redis, BlobStorage/FileSystemStorage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setup-environment-variable-file">3. Setup environment variable file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#init-the-database-create-first-superuser-via-cli-and-prefill-e-mail-templates">4. Init the database, create first superuser via cli and prefill e-mail templates</a></li>
<li class="toctree-l4"><a class="reference internal" href="#start-the-container">5. Start the container</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optional-6-use-flower-to-monitor-tasks">[Optional] 6. Use Flower to monitor tasks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optional-7-use-azure-read-api-on-premise">[Optional] 7. Use Azure Read API on-premise</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optional-8-install-document-segmentation-container">[Optional] 8. Install document segmentation container</a></li>
<li class="toctree-l4"><a class="reference internal" href="#a-upgrade-to-newer-konfuzio-version">9a. Upgrade to newer Konfuzio Version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#b-downgrade-to-older-konfuzio-version">9b. Downgrade to older Konfuzio Version</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#alternative-deployment-options">Alternative deployment options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-ai-model-training-via-ci-pipelines">Custom AI model training via CI pipelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#keycloak-integration">Keycloak Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#set-up">Set up</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables">Environment Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#important-notes">Important notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#migrate-ais-and-projects">Migrate AIs and Projects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#migrate-an-extraction-or-categorization-ai">Migrate an Extraction or Categorization AI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#download-extraction-ai-from-source-instance">Download extraction AI from source instance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upload-extraction-or-category-ai-to-target-instance">Upload Extraction or Category AI to target instance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#note">Note:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migrate-a-project">Migrate a Project</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#database-and-storage">Database and Storage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage-of-postgresql">Usage of PostgreSQL</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">Environment Variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables-for-konfuzio-server">Environment Variables for Konfuzio Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables-for-read-api-container">Environment Variables for Read API Container</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables-for-detectron-container">Environment Variables for Detectron Container</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog_app.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Konfuzio</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>On-Premises Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/web/on_premises.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="on-premises-documentation">
<span id="server-installation"></span><h1>On-Premises Documentation<a class="headerlink" href="#on-premises-documentation" title="Permalink to this headline">¶</a></h1>
<p>On-premises, also known as self-hosted, is a setup that allows Konfuzio to be implemented 100% on your own infrastructure. In practice, it means that you know where your data is stored, how it’s handled and who gets hold of it. This is because you keep the data on your own servers.</p>
<p>A common way to operate a production-ready and scalabe Konfuzio installation is via Kubernetes. An alternative and more light-weight deployment option is the <a class="reference external" href="/web/on_premises.html#alternative-deployment-options">Single VM setup via Docker</a>. We recommend to use the option which is more familiar to you.</p>
<p>On-Premise Konfuzio installations allow to create Superuser accounts which can access all <a class="reference external" href="https://help.konfuzio.com/modules/superuserdocuments/index.html">Documents</a>, <a class="reference external" href="https://help.konfuzio.com/modules/superuserprojects/index.html">Projects</a> and <a class="reference external" href="https://help.konfuzio.com/modules/superuserais/index.html">AIs</a> via a dedicated view as well as creating custom <a class="reference external" href="https://help.konfuzio.com/modules/superuserroles/index.html">Roles</a></p>
<section id="kubernetes">
<h2>Kubernetes<a class="headerlink" href="#kubernetes" title="Permalink to this headline">¶</a></h2>
<section id="required-tools">
<h3>Required tools<a class="headerlink" href="#required-tools" title="Permalink to this headline">¶</a></h3>
<p>Before deploying Konfuzio to your Kubernetes cluster, there are some tools you must have installed locally.</p>
<section id="kubectl">
<h4>kubectl<a class="headerlink" href="#kubectl" title="Permalink to this headline">¶</a></h4>
<p>kubectl is the tool that talks to the Kubernetes API. kubectl 1.15 or higher is required and it needs to be compatible
with your cluster (<a class="reference external" href="https://kubernetes.io/docs/tasks/tools/#before-you-begin">+/-1 minor release from your cluster</a>).</p>
<p><a class="reference external" href="https://kubernetes.io/docs/tasks/tools/#install-kubectl">&gt; Install kubectl locally by following the Kubernetes documentation</a>.</p>
<p>The server version of kubectl cannot be obtained until we connect to a cluster. Proceed
with setting up Helm.</p>
</section>
<section id="helm">
<h4>Helm<a class="headerlink" href="#helm" title="Permalink to this headline">¶</a></h4>
<p>Helm is the package manager for Kubernetes. Konfuzio is tested and supported with Helm v3.</p>
<section id="getting-helm">
<h5>Getting Helm<a class="headerlink" href="#getting-helm" title="Permalink to this headline">¶</a></h5>
<p>You can get Helm from the project’s <a class="reference external" href="https://github.com/helm/helm/releases">releases page</a>, or follow other options
under the official documentation of <a class="reference external" href="https://helm.sh/docs/intro/install/">installing Helm</a>.</p>
<section id="connect-to-a-local-minikube-cluster">
<h6>Connect to a local Minikube cluster<a class="headerlink" href="#connect-to-a-local-minikube-cluster" title="Permalink to this headline">¶</a></h6>
<p>For test purposes you can use <code class="docutils literal notranslate"><span class="pre">minikube</span></code> as your local cluster. If <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">cluster-info</span></code>
is not showing <code class="docutils literal notranslate"><span class="pre">minikube</span></code> as the current cluster, use <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">config</span> <span class="pre">set-cluster</span>
<span class="pre">minikube</span></code> to set the active cluster. For clusters in production please visit the <a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/">Kubernetes
Documentation</a>.</p>
</section>
</section>
<section id="initializing-helm">
<h5>Initializing Helm<a class="headerlink" href="#initializing-helm" title="Permalink to this headline">¶</a></h5>
<p>If Helm v3 is being used, there no longer is an <code class="docutils literal notranslate"><span class="pre">init</span></code> sub command and the command is
ready to be used once it is installed. Otherwise please upgrade Helm.</p>
</section>
</section>
<section id="next-steps">
<h4>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h4>
<p>Once kubectl and Helm are configured, you can continue to configuring your Kubernetes
cluster.</p>
</section>
</section>
<section id="deployment">
<h3>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h3>
<p>Before running <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span></code>, you need to make some decisions about how you will run
Konfuzio. Options can be specified using Helm’s <code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">option.name=value</span></code> or <code class="docutils literal notranslate"><span class="pre">--values=my_values.yaml</span></code> command
line option. A complete list of command line options can be found <a class="reference external" href="https://helm.sh/docs/helm/">here</a>. This guide will
cover required values and common options.</p>
<p>Create a values.yaml file for your Konfuzio configuration. See Helm docs for information on how your values file will override the defaults.
Useful default values can be found in the <a class="reference external" href="https://git.konfuzio.com/shared/charts/-/blob/master/values.yaml">values.yaml</a> in the chart <a class="reference external" href="https://git.konfuzio.com/shared/charts">repository</a>.</p>
<section id="selecting-configuration-options">
<h4>Selecting configuration options<a class="headerlink" href="#selecting-configuration-options" title="Permalink to this headline">¶</a></h4>
<p>In each section collect the options that will be combined to use with <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span></code>.</p>
<section id="secrets">
<h5>Secrets<a class="headerlink" href="#secrets" title="Permalink to this headline">¶</a></h5>
<p>There are some secrets that need to be created (e.g. SSH keys). By default they will be
generated automatically.</p>
</section>
<section id="networking-and-dns">
<h5>Networking and DNS<a class="headerlink" href="#networking-and-dns" title="Permalink to this headline">¶</a></h5>
<p>By default, Konfuzio relies on Kubernetes <code class="docutils literal notranslate"><span class="pre">Service</span></code> objects of <code class="docutils literal notranslate"><span class="pre">type:</span> <span class="pre">LoadBalancer</span></code> to
expose Konfuzio services using name-based virtual servers configured with <code class="docutils literal notranslate"><span class="pre">Ingress</span></code>
objects. You’ll need to specify a domain which will contain records to resolve the
domain to the appropriate IP.</p>
<p><code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">ingress.enabled=True</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">ingress.HOST_NAME=konfuzio.example.com</span></code></p>
<!--
###### IPs

If you plan to use an automatic DNS registration service,you won't need any additional
configuration for Konfuzio, but you will need to deploy it to your cluster.

If you plan to manually configure your DNS records they should all point to a static IP.
For example if you choose `example.com` and you have a static IP of `10.10.10.10`, then
`konfuzio.example.com`, `registry.example.com` and `minio.example.com` (if using MinIO) should all resolve to
`10.10.10.10`.

_Include these options in your Helm install command:_

`--set global.hosts.externalIP=10.10.10.`
--></section>
<section id="persistence">
<h5>Persistence<a class="headerlink" href="#persistence" title="Permalink to this headline">¶</a></h5>
<p>By default the setup will create Volume Claims with the expectation that a dynamic
provisioner will create the underlying Persistent Volumes. If you would like to customize
the storageClass or manually create and assign volumes,please review the <a class="reference external" href="https://kubernetes.io/docs/concepts/storage/volumes/">storage
documentation</a>.</p>
<p><strong>Important</strong> : After initial installation, making changes to your storage settings requires manually editing Kubernetes
objects, so it’s best to plan ahead before installing your production instance of Konfuzio to avoid extra storage
migration work.</p>
</section>
<section id="tls-certificates">
<h5>TLS certificates<a class="headerlink" href="#tls-certificates" title="Permalink to this headline">¶</a></h5>
<p>You should be running Konfuzio using https which requiresTLS certificates. By default, the setup will install and
configure <a class="reference external" href="https://github.com/jetstack/cert-manager">cert-manager</a> to obtain free TLS certificates. If you
have your own wildcard certificate, you already have cert-manager installed, or you have
some other way of obtaining TLS certificates. For the default configuration, you must
specify an email address to register your TLS certificates.</p>
<p><em>Include these options in your Helm install command:</em></p>
<p><code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">certmanager-issuer.email=me&#64;example.com</span></code></p>
</section>
<section id="postgresql">
<h5>PostgreSQL<a class="headerlink" href="#postgresql" title="Permalink to this headline">¶</a></h5>
<p>By default this Konfuzio provides an in-cluster PostgreSQL database, for trial purposes
only.</p>
<p><strong>NOTE: This configuration is not recommended for use in production.</strong></p>
<ul class="simple">
<li><p>A single, non-resilient Deployment is used</p></li>
</ul>
<p>You can read more about setting up your production-readydatabase in the PostgreSQL
documentation. As soon you have an external PostgreSQL database ready, Konfuzio can
be configured to use it as shown below.</p>
<p><em>Include these options in your Helm install command:</em></p>
<p><code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">postgresql.install=false</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">global.psql.host=production.postgress.hostname.local</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">global.psql.password.secret=kubernetes_secret_name</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">global.psql.password.key=key_that_contains_postgres_password</span></code></p>
</section>
<section id="redis">
<h5>Redis<a class="headerlink" href="#redis" title="Permalink to this headline">¶</a></h5>
<p>All the Redis configuration settings are configured automatically.</p>
</section>
<section id="persistent-volume">
<h5>Persistent Volume<a class="headerlink" href="#persistent-volume" title="Permalink to this headline">¶</a></h5>
<p>Konfuzio relies on object storage for highly-available persistent data in Kubernetes. By default, Konfuzio uses a
<a class="reference external" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">persistent volume</a> within the cluster.</p>
<!--
##### Outgoing email

By default outgoing email is disabled. To enable it,provide details for your SMTP server
using the `global.smtp` and `global.email` settings. You can find details for these
settings in the command line options.

`--set global.smtp.address=smtp.example.com:587`
`--set global.smtp.AuthUser=username-here`
`--set global.smtp.AuthPass=password-here`
--></section>
<section id="cpu-gpu-and-ram-resource-requirements">
<h5>CPU, GPU and RAM Resource Requirements<a class="headerlink" href="#cpu-gpu-and-ram-resource-requirements" title="Permalink to this headline">¶</a></h5>
<p>The resource requests, and number of replicas for the Konfuzio components in this
setup are set by default to be adequate for a small production deployment. This is
intended to fit in a cluster with at least 8 vCPU with AVX2 support enabled, 32 GB of
RAM and one Nvidia GPU with minimum 4GB which supports at least CUDA10.1 and CUDNN 7.0. If you are
trying to deploy a non-production instance, you can reduce the defaults in order to fit
into a smaller cluster. Konfuzio can work without a GPU. The GPU is used to train and run Categorization AIs. We observe a 5x faster training and a 2x faster execution on GPU compared to CPU. Most Konfuzio Installations do not use GPUs.</p>
</section>
</section>
<section id="deploy-using-helm">
<h4>Deploy using Helm<a class="headerlink" href="#deploy-using-helm" title="Permalink to this headline">¶</a></h4>
<p>Once you have all of your configuration options collected, we can get any dependencies
and run Helm. In this example, we’ve named our Helm release <code class="docutils literal notranslate"><span class="pre">konfuzio</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">repo</span> <span class="pre">add</span> <span class="pre">konfuzio-repo</span> <span class="pre">https://git.konfuzio.com/api/v4/projects/106/packages/helm/stable</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">repo</span> <span class="pre">update</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">upgrade</span> <span class="pre">--install</span> <span class="pre">konfuzio</span> <span class="pre">konfuzio-repo/konfuzio-chart</span> <span class="pre">--values</span> <span class="pre">my_values.yaml</span></code></p>
<p>Please create a my_values.yaml file for your Konfuzio configuration. Useful default values can be found in the values.yaml in the chart repository. See Helm docs for information on how your values file will override the defaults. Alternativ you can specify you configuration using <code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">option.name=value</span></code>.</p>
</section>
<section id="monitoring-the-deployment">
<h4>Monitoring the Deployment<a class="headerlink" href="#monitoring-the-deployment" title="Permalink to this headline">¶</a></h4>
<p>The status of the deployment can be checked by running <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">status</span> <span class="pre">konfuzio</span></code> which
can also be done while the deployment is taking place if you run the command in
another terminal.</p>
</section>
<section id="initial-login">
<h4>Initial login<a class="headerlink" href="#initial-login" title="Permalink to this headline">¶</a></h4>
<p>You can access the Konfuzio instance by visiting the domain specified during
installation. In order to create an initial superuser, please to connect to a running pod.</p>
<p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pod</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">exec</span> <span class="pre">--stdin</span> <span class="pre">--tty</span> <span class="pre">my-konfuzio-*</span> <span class="pre">--</span>&#160; <span class="pre">bash</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">createsuperuser</span></code></p>
<!--
#### Initial login

You can access the Konfuzio instance by visiting the domain specified during
installation. If you manually created the secret for initial root password, you can use that
to sign in as `root` user. If not, Konfuzio would've automatically created a random
password for `root` user. This can be extracted by the following command (replace
`<name>` by name of the release - which is `konfuzio` if you used the command above).

`kubectl get secret <name>-konfuzio-initial-root-password`
`-ojsonpath='{.data.password}' | base64 --decode ; echo`
--></section>
</section>
<section id="upgrade">
<h3>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this headline">¶</a></h3>
<p>Before upgrading your Konfuzio installation, you need to check the <a class="reference external" href="./changelog_app.html">changelog</a>
corresponding to the specific release you want to upgrade to and look for any that might
pertain to the new version.</p>
<p>We also recommend that you take a backup first.</p>
<p>Upgrade Konfuzio following our standard procedure,with the following additions of:</p>
<ol class="arabic simple">
<li><p>Check the change log for the specific version you would like to upgrade to</p></li>
<li><p>Ensure that you have created a <a class="reference external" href="https://www.postgresql.org/docs/11/backup.html">PostgreSQL backup</a> in the previous
step. Without a backup, Konfuzio data might be lost if the upgrade fails.</p></li>
<li><p>Go through deployment section step by step</p></li>
<li><p>Extract your previous <code class="docutils literal notranslate"><span class="pre">--set</span></code> arguments with (see Action1)</p></li>
<li><p>Decide on all the values you need to set</p></li>
<li><p>Perform the upgrade, with all <code class="docutils literal notranslate"><span class="pre">--set</span></code> arguments extracted(see Action 2)</p></li>
<li><p>We will perform the migrations for the Database for PostgreSQL automatically.</p></li>
</ol>
<p><em>Action 1</em></p>
<p><code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">get</span> <span class="pre">values</span> <span class="pre">konfuzio</span> <span class="pre">&gt;</span> <span class="pre">konfuzio.yaml</span></code></p>
<p><em>Action 2</em></p>
<p><code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">upgrade</span> <span class="pre">kofuzio</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--version</span> <span class="pre">&lt;new</span> <span class="pre">version&gt;</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">-f</span> <span class="pre">konfuzio.yaml</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">konfuzio.migrations.enabled=true</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">...</span></code></p>
</section>
</section>
<section id="docker">
<h2>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h2>
<section id="single-vm-setup">
<h3>Single VM setup<a class="headerlink" href="#single-vm-setup" title="Permalink to this headline">¶</a></h3>
<p>Konfuzio can be configured to run on a single virtual machine, without relying on
Kubernetes. In this scenario, all necessary containers are started manually or with a
container orchestration tool of your choice.</p>
<p>We recommend a virtual machine with a minimum of 8 vCPU (incl. AVX2 support) and
32 GB of RAM and an installed Docker runtime. A Nvidia GPU is recommended but not
required. In this setup Konfuzio is running in the context of the Docker executor,
therefore there are no strict requirements for the VMs operating systems. However, we
recommend a Linux VM with Debian, Ubuntu, CentOS,or Redhat Linux.</p>
<section id="download-docker-image">
<h4>1. Download Docker Image<a class="headerlink" href="#download-docker-image" title="Permalink to this headline">¶</a></h4>
<p>The Konfuzio docker image can be downloaded via “docker pull”. We will provide you
with the credentials. This action requires an internet connection.</p>
<p>The internet connection can be turned off once the download is complete. In case there is
no internet connection available during setup, the container must be transferred with an
alternative method as a file to the virtual machine.</p>
<p>Registry URL: {PROVIDED_BY_KONFUZIO}<span class="raw-html-m2r"><br></span>
Username: {PROVIDED_BY_KONFUZIO}<span class="raw-html-m2r"><br></span>
Password: {PROVIDED_BY_KONFUZIO}</p>
<p><code class="docutils literal notranslate"><span class="pre">&gt;</span> <span class="pre">docker</span> <span class="pre">login</span> <span class="pre">REGISTRY_URL</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">&gt;</span> <span class="pre">docker</span> <span class="pre">pull</span> <span class="pre">REGISTRY_URL/konfuzio/text-annotation/master:latest</span></code></p>
<p>The Tag “latest” should be replaced with an actual version. A list of available tags can be found here: <a class="reference external" href="https://dev.konfuzio.com/web/changelog_app.html">https://dev.konfuzio.com/web/changelog_app.html</a>.</p>
</section>
<section id="setup-postgresql-redis-blobstorage-filesystemstorage">
<h4>2. Setup PostgreSQL, Redis, BlobStorage/FileSystemStorage<a class="headerlink" href="#setup-postgresql-redis-blobstorage-filesystemstorage" title="Permalink to this headline">¶</a></h4>
<p>The database credentials are needed in this step. Please ensure your selected <a class="reference external" href="/web/on_premises.html#database-and-storage">databases</a> are setup at this point. You may want to use psql and redis-cli to check if database credentials are working.</p>
<p>In case you use FileSystemStorage and Docker volume mounts, you need to make sure the volume can be accessed by the konfuzio docker user (uid=999). You might want to run “chown 999:999 -R /konfuzio-vm/text-annotation/data” on the host VM.</p>
</section>
<section id="setup-environment-variable-file">
<h4>3. Setup environment variable file<a class="headerlink" href="#setup-environment-variable-file" title="Permalink to this headline">¶</a></h4>
<p>Copy the /code/.env.example file from the container and adapt it to your settings. The .env file can be saved anywhere on the host VM. In this example we use “/konfuzio-vm/text-annotation.env”.</p>
</section>
<section id="init-the-database-create-first-superuser-via-cli-and-prefill-e-mail-templates">
<h4>4. Init the database, create first superuser via cli and prefill e-mail templates<a class="headerlink" href="#init-the-database-create-first-superuser-via-cli-and-prefill-e-mail-templates" title="Permalink to this headline">¶</a></h4>
<p>In this example we store the files on the host VM and mount the directory “/konfuzio-vm/text-annotation/data” into the container. In the first step we create a container with a shell to then start the initialization scripts within the container.
The container needs to be able to access IP addresses and hostnames used in the .env. This can be ensured using –add.host. In the example we make the host IP 10.0.0.1 available.</p>
<p>docker run -it –add-host=10.0.0.1 –env-file /konfuzio-vm/text-annotation.env –mount type=bind,source=/konfuzio-vm/text-annotation/data,target=/data REGISTRY_URL/konfuzio/text-annotation/master:latest bash</p>
<p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">createsuperuser</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">init_email_templates</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">init_user_permissions</span></code></p>
<p>After completing these steps you can exit and remove the container.</p>
<p>Note: The username used during the createsuperuser dialog must have the format of a valid e-mail in order to be able to login later.</p>
</section>
<section id="start-the-container">
<h4>5. Start the container<a class="headerlink" href="#start-the-container" title="Permalink to this headline">¶</a></h4>
<p>In this example we start three containers, the first one to serve the Konfuzio web application. The second and third are used to process tasks in the background without blocking the web application.</p>
<p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-p</span> <span class="pre">80:8000</span> <span class="pre">--name</span> <span class="pre">web</span> <span class="pre">-d</span> <span class="pre">--add-host=host:10.0.0.1</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--env-file</span> <span class="pre">/konfuzio-vm/text-annotation.env</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--mount</span> <span class="pre">type=bind,source=/konfuzio-vm/text-annotation/data,target=/data</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">REGISTRY_URL/konfuzio/text-annotation/master:latest</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--name</span> <span class="pre">worker1</span> <span class="pre">-d</span> <span class="pre">--add-host=host:10.0.0.1</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--env-file</span> <span class="pre">/konfuzio-vm/text-annotation.env</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--mount</span> <span class="pre">type=bind,source=/konfuzio-vm/text-annotation/data,target=/data</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">REGISTRY_URL/konfuzio/text-annotation/master:latest</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">celery</span> <span class="pre">-A</span> <span class="pre">app</span> <span class="pre">worker</span> <span class="pre">-l</span> <span class="pre">INFO</span> <span class="pre">--concurrency</span> <span class="pre">1</span> <span class="pre">-Q</span> <span class="pre">celery,priority_ocr,ocr,\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">priority_extract,extract,processing,priority_local_ocr,local_ocr,\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">training,finalize,training_heavy,categorize</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--name</span> <span class="pre">worker2</span> <span class="pre">-d</span> <span class="pre">--add-host=host:10.0.0.1</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--env-file</span> <span class="pre">/konfuzio-vm/text-annotation.env</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">--mount</span> <span class="pre">type=bind,source=/konfuzio-vm/text-annotation/data,target=/data</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">REGISTRY_URL/konfuzio/text-annotation/master:latest</span> <span class="pre">\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">celery</span> <span class="pre">-A</span> <span class="pre">app</span> <span class="pre">worker</span> <span class="pre">-l</span> <span class="pre">INFO</span> <span class="pre">--concurrency</span> <span class="pre">1</span> <span class="pre">-Q</span> <span class="pre">celery,priority_ocr,ocr,\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">priority_extract,extract,processing,priority_local_ocr,local_ocr,\</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">training,finalize,training_heavy,categorize</span></code></p>
</section>
<section id="optional-6-use-flower-to-monitor-tasks">
<h4>[Optional] 6. Use Flower to monitor tasks<a class="headerlink" href="#optional-6-use-flower-to-monitor-tasks" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://flower.readthedocs.io/en/latest/screenshots.html">Flower</a> can be used a task monitoring tool. Flower will be only accessible for Konfuzio superusers and is part of the Konfuzio Server Docker Image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>`docker run --name flower -d --add-host=host:10.0.0.1 \`
`--env-file /konfuzio-vm/text-annotation.env \`
`--mount type=bind,source=/konfuzio-vm/text-annotation/data,target=/data \`
`REGISTRY_URL/konfuzio/text-annotation/master:latest \`
`celery -A app flower --url_prefix=flower --address=0.0.0.0 --port=5555`
</pre></div>
</div>
<p>The Konfuzio Server application acts as a reverse proxy an servers the flower application. Therefore, django needs to know the flower url. <code class="docutils literal notranslate"><span class="pre">FLOWER_URL=http://host:5555/flower</span></code>.</p>
<div class="mermaid">
            graph LR
subgraph Network
a(&quot;User&quot;)
end
subgraph Local Network / Cluster Network
a(&quot;User&quot;) --&gt; e(&quot;Konfuzio Server&quot;)
e(&quot;Konfuzio Server&quot;) -- FLOWER_URL --&gt; f(&quot;Flower&quot;)
end
        </div><p>Please ensure that the Flower container is not exposed externally, as it does not handle authentication and authorization itself.</p>
</section>
<section id="optional-7-use-azure-read-api-on-premise">
<h4>[Optional] 7. Use Azure Read API on-premise<a class="headerlink" href="#optional-7-use-azure-read-api-on-premise" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference external" href="https://docs.microsoft.com/en-us/azure/cognitive-services/computer-vision/computer-vision-how-to-install-containers?tabs=version-3-2">Azure Read API</a> can be installed on-premise and used togehter with Konfuzio.</p>
<p>Please install the Read API Container according to the current <a class="reference external" href="https://docs.microsoft.com/en-us/azure/cognitive-services/computer-vision/computer-vision-how-to-install-containers?tabs=version-3-2">manual</a></p>
<p>Once the Azure Read API container is running you need to set the following variables in the .env file. This for example look like the following:</p>
<p><code class="docutils literal notranslate"><span class="pre">AZURE_OCR_KEY=123456789</span> <span class="pre">#</span> <span class="pre">The</span> <span class="pre">Azure</span> <span class="pre">OCR</span> <span class="pre">API</span> <span class="pre">key</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">AZURE_OCR_BASE_URL=http://host:5000</span> <span class="pre">#</span> <span class="pre">The</span> <span class="pre">URL</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">READ</span> <span class="pre">API</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">AZURE_OCR_VERSION=v3.2</span> <span class="pre">#</span> <span class="pre">The</span> <span class="pre">version</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">READ</span> <span class="pre">API</span></code></p>
</section>
<section id="optional-8-install-document-segmentation-container">
<h4>[Optional] 8. Install document segmentation container<a class="headerlink" href="#optional-8-install-document-segmentation-container" title="Permalink to this headline">¶</a></h4>
<p>Download the container with the credentials provided by Konfuzio</p>
<p>Registry URL: {PROVIDED_BY_KONFUZIO}<span class="raw-html-m2r"><br></span>
Username: {PROVIDED_BY_KONFUZIO}<span class="raw-html-m2r"><br></span>
Password: {PROVIDED_BY_KONFUZIO}</p>
<p><code class="docutils literal notranslate"><span class="pre">&gt;</span> <span class="pre">docker</span> <span class="pre">login</span> <span class="pre">REGISTRY_URL</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">&gt;</span> <span class="pre">docker</span> <span class="pre">pull</span> <span class="pre">REGISTRY_URL/konfuzio/detectron2:2022-01-30_20-56-28</span></code><span class="raw-html-m2r"><br></span>
<code class="docutils literal notranslate"><span class="pre">&gt;</span> <span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--env-file</span> <span class="pre">/path_to_env_file.env</span> <span class="pre">REGISTRY_URL/konfuzio/detectron2:2022-01-30_20-56-28</span> <span class="pre">bash</span> <span class="pre">-c</span> <span class="pre">&quot;export</span> <span class="pre">LC_ALL=C.UTF-8;</span> <span class="pre">export</span> <span class="pre">LANG=C.UTF-8;</span> <span class="pre">./run_celery.sh&quot;</span></code></p>
<p>The segmentation container needs to be started with the following environment variables which you can enter into your .env file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GPU</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># If GPU is present</span>
<span class="n">C_FORCE_ROOT</span><span class="o">=</span><span class="kc">True</span>
<span class="n">BROKER_URL</span><span class="o">=</span>  <span class="c1"># See the konfuzio container</span>
<span class="n">RESULT_BACKEND</span><span class="o">=</span>  <span class="c1"># See the konfuzio container</span>
<span class="n">SENTRY_ENVIRONMENT</span><span class="o">=</span>  <span class="c1"># Optional</span>
<span class="n">SENTRY_RELEASE</span><span class="o">=</span>  <span class="c1"># Optional</span>
<span class="n">SENTRY_DSN</span><span class="o">=</span>  <span class="c1"># Optional</span>
</pre></div>
</div>
</section>
<section id="a-upgrade-to-newer-konfuzio-version">
<h4>9a. Upgrade to newer Konfuzio Version<a class="headerlink" href="#a-upgrade-to-newer-konfuzio-version" title="Permalink to this headline">¶</a></h4>
<p>Konfuzio upgrades are performed by replacing the Docker Tag to the <a class="reference external" href="https://dev.konfuzio.com/web/changelog_app.html">desired version</a>
After starting the new Containers Database migrations need to be applied by <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code> (see 4.).
In case additional migration steps are needed, they will be mentioned in the release notes.</p>
</section>
<section id="b-downgrade-to-older-konfuzio-version">
<h4>9b. Downgrade to older Konfuzio Version<a class="headerlink" href="#b-downgrade-to-older-konfuzio-version" title="Permalink to this headline">¶</a></h4>
<p>Konfuzio downgrades are performed by creating a fresh Konfuzio installation in which existing Projects can be imported.
The following steps need to be undertaken:</p>
<ul class="simple">
<li><p>Export the Projects that you want to have available after downgrade using <a class="reference external" href="https://help.konfuzio.com/integrations/migration-between-konfuzio-server-instances/index.html#migrate-projects-between-konfuzio-server-instances">konfuzio_sdk</a>. Please make sure you use a SDK version that is compatible with the Konfuzio Server version you want to migrate to.</p></li>
<li><p>Create a new Postgres Database and a new Folder/Bucket for file storage which will be used for the downgraded version</p></li>
<li><p>Install the desired Konfuzio Server version by starting with 1.)</p></li>
<li><p>Import the projects using <a class="reference external" href="[konfuzio_sdk](https://help.konfuzio.com/integrations/migration-between-konfuzio-server-instances/index.html#migrate-projects-between-konfuzio-server-instances">“python manage.py project_import”</a></p></li>
</ul>
</section>
</section>
</section>
<section id="alternative-deployment-options">
<h2>Alternative deployment options<a class="headerlink" href="#alternative-deployment-options" title="Permalink to this headline">¶</a></h2>
<section id="custom-ai-model-training-via-ci-pipelines">
<h3>Custom AI model training via CI pipelines<a class="headerlink" href="#custom-ai-model-training-via-ci-pipelines" title="Permalink to this headline">¶</a></h3>
<p>Konfuzio uses CI pipelines to allow users to run customAI model code securely. In case
the Kubernetes deployment option is not used, we recommend a dedicated virtual
machine to run these pipelines. The selected CI application needs to support Docker
and webhooks. The CI application needs network access to the Konfuzio installation.</p>
</section>
</section>
<section id="keycloak-integration">
<h2>Keycloak Integration<a class="headerlink" href="#keycloak-integration" title="Permalink to this headline">¶</a></h2>
<p>Keycloak allows single sign-on funtionality. By doing so no user management is done wihtin Konfuzio Server. If you already operate a keycloak server, you can reuse keycloak users.</p>
<section id="set-up">
<h3>Set up<a class="headerlink" href="#set-up" title="Permalink to this headline">¶</a></h3>
<p>To start and set up keycloak server:</p>
<ol class="arabic">
<li><p>Download <a class="reference external" href="https://www.keycloak.org/downloads">keycloak server</a></p></li>
<li><p>Install and start keycloak server using <a class="reference external" href="https://www.keycloak.org/docs/latest/server_installation/">instruction</a></p></li>
<li><p>Open keycloak dashboard in browser (locally it’s <a class="reference external" href="http://0.0.0.0:8080/">http://0.0.0.0:8080/</a>).</p></li>
<li><p>Create admin user</p></li>
<li><p>Login to Administration Console</p></li>
<li><p>You can add new Realm or use default (Master)</p>
<a class="reference external image-reference" href="keycloak/add-realm.png"><img alt="add-realm.png" src="../_images/add-realm.png" /></a>
</li>
<li><p>Create new client from <code class="docutils literal notranslate"><span class="pre">Clients</span></code> navbar item</p>
<a class="reference external image-reference" href="keycloak/add-client.png"><img alt="add-client.png" src="../_images/add-client.png" /></a>
</li>
<li><p>Fill client form correctly (<code class="docutils literal notranslate"><span class="pre">Access</span> <span class="pre">Type</span></code> and <code class="docutils literal notranslate"><span class="pre">Valid</span> <span class="pre">Redirect</span> <span class="pre">URIs</span></code> fields)</p>
<a class="reference external image-reference" href="keycloak/client-form.png"><img alt="client-form.png" src="../_images/client-form.png" /></a>
</li>
<li><p>Move to <code class="docutils literal notranslate"><span class="pre">Credentials</span></code> tab and save <code class="docutils literal notranslate"><span class="pre">Secret</span></code> value</p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">Users</span></code> navbar item create users</p></li>
</ol>
</section>
<section id="environment-variables">
<h3>Environment Variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h3>
<p>To integrate konfuzio with keycloak you need to set the following environment variables for you Konfuzio Server installation:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">KEYCLOAK_URL</span></code> (<a class="reference external" href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a> - for localhost)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OIDC_RP_SIGN_ALGO</span></code> (<code class="docutils literal notranslate"><span class="pre">RS256</span></code> - by default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OIDC_RP_CLIENT_ID</span></code> (client name from 7th point of previous section)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OIDC_RP_CLIENT_SECRET</span></code> (Secret value from 9th point of previous section)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SSO_ENABLED</span></code> (set <code class="docutils literal notranslate"><span class="pre">True</span></code> to activate integration)</p></li>
</ul>
<p>Click <code class="docutils literal notranslate"><span class="pre">SSO</span></code> on login page to log in to Konfuzio using keycloak</p>
<a class="reference external image-reference" href="keycloak/sso-button.png"><img alt="sso-button.png" src="../_images/sso-button.png" /></a>
</section>
<section id="important-notes">
<h3>Important notes<a class="headerlink" href="#important-notes" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>The Keycloak admin user cannot login into Konfuzio Server.</p></li>
</ul>
</section>
</section>
<section id="migrate-ais-and-projects">
<h2>Migrate AIs and Projects<a class="headerlink" href="#migrate-ais-and-projects" title="Permalink to this headline">¶</a></h2>
<section id="migrate-an-extraction-or-categorization-ai">
<h3>Migrate an Extraction or Categorization AI<a class="headerlink" href="#migrate-an-extraction-or-categorization-ai" title="Permalink to this headline">¶</a></h3>
<p>This feature is only available for on-prem customers.</p>
</section>
<section id="download-extraction-ai-from-source-instance">
<h3>Download extraction AI from source instance<a class="headerlink" href="#download-extraction-ai-from-source-instance" title="Permalink to this headline">¶</a></h3>
<p>In a first step the extraction AI needs to be downloaded from the target Konfuzio instance. In order to download the extraction AI you need to be a superuser.
The extraction AI can be downloaded from the superuser AI page.</p>
<a class="reference external image-reference" href="./migration-between-konfuzio-server-instances/select_AI.png"><img alt="select_AI.png" src="../_images/select_AI.png" /></a>
<p>Click on the extraction AI you want to migrate.</p>
<a class="reference external image-reference" href="./migration-between-konfuzio-server-instances/download_AI.png"><img alt="download_AI.png" src="../_images/download_AI.png" /></a>
<p>Download the AI file.</p>
</section>
<section id="upload-extraction-or-category-ai-to-target-instance">
<h3>Upload Extraction or Category AI to target instance<a class="headerlink" href="#upload-extraction-or-category-ai-to-target-instance" title="Permalink to this headline">¶</a></h3>
<p>Upload the downloaded extraction AI via superuser AI page.</p>
<a class="reference external image-reference" href="./migration-between-konfuzio-server-instances/upload_AI.png"><img alt="upload_AI.png" src="../_images/upload_AI.png" /></a>
</section>
<section id="note">
<h3>Note:<a class="headerlink" href="#note" title="Permalink to this headline">¶</a></h3>
<p>In case of an Extraction AI, a target category needs to be chosen. A project relation is made by means of choosing a “project - category” relation in “Available Category”. No project should be assigned in the shown “Available projects” select box.
In comparison for a Categorization AI the targe project has to be chosen from “Available projects”.</p>
<a class="reference external image-reference" href="./migration-between-konfuzio-server-instances/create_label_sets.png"><img alt="create_label_sets.png" src="../_images/create_label_sets.png" /></a>
<p>If you upload the extraction AI to a new project without the labels and label set, you need to enable “Create labels and templates” on the respective project.</p>
</section>
<section id="migrate-a-project">
<h3>Migrate a Project<a class="headerlink" href="#migrate-a-project" title="Permalink to this headline">¶</a></h3>
<p>Export the project data from the source Konfuzio server system.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">konfuzio_sdk</span>
<span class="n">konfuzio_sdk</span> <span class="n">init</span>
<span class="n">konfuzio_sdk</span> <span class="n">export_project</span> <span class="o">&lt;</span><span class="n">PROJECT_ID</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The export will be saved in a folder with the name <a href="#id7"><span class="problematic" id="id8">data_</span></a><span class="raw-html-m2r"><project_id></span>. This folder needs to be transferred to the target system
The first argument is the path to the export folder, the second is the project name of the imported project on the target system.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">project_import</span> <span class="s2">&quot;/konfuzio-target-system/data_123/&quot;</span> <span class="s2">&quot;NewProjectName&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="database-and-storage">
<h2>Database and Storage<a class="headerlink" href="#database-and-storage" title="Permalink to this headline">¶</a></h2>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p>To run Konfuzio Server, three types of storages are required. First, a PostgreSQL database is needed to store structured application data. Secondly, a storage for Blob needs to be present. Thirdly, a Redis database that manages the background Task of Konfuzio Server is needed. You can choose your preferred deployment option for each storage type and connect Konfuzio via environment variables to the respective storages. We recommend planning your storage choices before starting with the actual Konfuzio installation.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Storage Name</p></th>
<th class="head"><p>Recommended Version</p></th>
<th class="head"><p>Supported Version</p></th>
<th class="head"><p>Deployment Options</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://www.postgresql.org/">Postgres</a></p></td>
<td><p>Latest Stable</p></td>
<td><p>PostgreSQL 11 and higher</p></td>
<td><p>Managed (Cloud) Service, VM Installation, Docker, In-Cluster*</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://redis.io/">Redis</a></p></td>
<td><p>Latest Stable</p></td>
<td><p>Redis 5 and higher</p></td>
<td><p>Managed (Cloud) Service, VM Installation, Docker, In-Cluster*</p></td>
</tr>
<tr class="row-even"><td><p>Blob Storage</p></td>
<td><p>Latest Stable</p></td>
<td><p>All with activ support</p></td>
<td><p>Filesystem, S3-compatible Storage (e.g. <a class="reference external" href="https://aws.amazon.com/s3/">Amazon S3</a>, <a class="reference external" href="https://azure.microsoft.com/en-us/products/storage/blobs/">Azure Blob Storage</a>)</p></td>
</tr>
</tbody>
</table>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>If you use <a class="reference external" href="/web/on_premises.html#kubernetes">Kubernetes Deployment</a> you can choose the ‘in-Cluster’ option for Postgres and Redis.</p>
</section>
<section id="usage-of-postgresql">
<h3>Usage of PostgreSQL<a class="headerlink" href="#usage-of-postgresql" title="Permalink to this headline">¶</a></h3>
<p>Konfuzio Server will create a total of 43 tables and use the following data types. This information refers to release <a class="reference external" href="https://dev.konfuzio.com/web/changelog_app.html#released-2022-10-28-07-23-39">2022-10-28-07-23-39</a>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>data_type</p></th>
<th class="head"><p>count</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>bigint</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-odd"><td><p>boolean</p></td>
<td><p>35</p></td>
</tr>
<tr class="row-even"><td><p>character varying</p></td>
<td><p>78</p></td>
</tr>
<tr class="row-odd"><td><p>date</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>double precision</p></td>
<td><p>29</p></td>
</tr>
<tr class="row-odd"><td><p>inet</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>integer</p></td>
<td><p>138</p></td>
</tr>
<tr class="row-odd"><td><p>jsonb</p></td>
<td><p>28</p></td>
</tr>
<tr class="row-even"><td><p>smallint</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>text</p></td>
<td><p>21</p></td>
</tr>
<tr class="row-even"><td><p>timestamp with time zone</p></td>
<td><p>56</p></td>
</tr>
<tr class="row-odd"><td><p>uuid</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<!-- This table was created by running select data_type, count(*) from information_schema.columns where table_schema = 'public'  group by data_type ; --></section>
</section>
<section id="id6">
<h2>Environment Variables<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<section id="environment-variables-for-konfuzio-server">
<h3>Environment Variables for Konfuzio Server<a class="headerlink" href="#environment-variables-for-konfuzio-server" title="Permalink to this headline">¶</a></h3>
<p>Konfuzio Server is fully configured via environment variables, these can be passed as dedicated environment variables or a single .env to the Konfuzio Server containers (REGISTRY_URL/konfuzio/text-annotation/master). A template for a .env file is provided here:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># False for production, True for local development (mandatory).
# See https://docs.djangoproject.com/en/3.2/ref/settings/#std:setting-DEBUG
DEBUG=

# Set maintenance mode, shows 503 error page when maintenance-mode is on (mandatory).
MAINTENANCE_MODE=False

# Insert random secret key (mandatory).
# See https://docs.djangoproject.com/en/4.0/ref/settings/#secret-key
SECRET_KEY=

# The HOSTNAME variable is used in the E-Mail templates (mandatory).
# https://example.konfuzio.com or http://localhost:8000 for local development.
# Note: Please include the protocol (e.g. http://) even the variable is named HOST_NAME
HOST_NAME=

# Please enter a Postgres Database (https://github.com/kennethreitz/dj-database-url#url-schema) (mandatory).
DATABASE_URL=
DATABASE_URL_SSL_REQUIRE=True

# Insert hostname e.g. konfuzio.com or * for local development (mandatory).
# See https://docs.djangoproject.com/en/4.0/ref/settings/#allowed-hosts
ALLOWED_HOSTS=

# Django&#39;s default storage (mandatory).
# for azure use: storage.MultiAzureStorage
# for S3-like storage use: storage.MultiS3Boto3Storage
# See https://docs.djangoproject.com/en/4.0/ref/settings/#default-file-storage
DEFAULT_FILE_STORAGE=django.core.files.storage.FileSystemStorage

# Required settings if storage.MultiAzureStorage is used (optional).
AZURE_ACCOUNT_KEY=
AZURE_ACCOUNT_NAME=
AZURE_CONTAINER=

# Required settings for storage.MultiS3Boto3Storage (optional).
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_STORAGE_BUCKET_NAME=
AWS_S3_REGION_NAME=
AWS_S3_ENDPOINT_URL=

# Access to customer Blob Storage (optional).
# e.g. &quot;{&#39;beispiel_ag&#39;: {&#39;account_key&#39;: &#39;the_keys_124&#39;,&#39;azure_container&#39;: &#39;default&#39;,}}&quot;
AZURE_CUSTOMER_STORAGE={}

# Celery settings (mandatory).
BROKER_URL=
RESULT_BACKEND=
TASK_ALWAYS_EAGER=True

# Defender settings (optional).
DEFENDER_REDIS_URL=

# SENTRY_DSN e.g. &quot;https://123456789@sentry.io/1234567&quot; (optional).
SENTRY_DSN=

# E-Mail address which is BCC in every transactional E-Mail (optional).
CRM_INTEGRATION_EMAIL=

# The SMTP credentials for sending E-Mails (optional).
# See https://docs.djangoproject.com/en/4.0/ref/settings/#email-backend
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=
EMAIL_HOST_PASSWORD=
EMAIL_HOST_USER=
EMAIL_PORT=25
# See https://docs.djangoproject.com/en/4.0/ref/settings/#email-use-tls
EMAIL_USE_TLS=False
# See https://docs.djangoproject.com/en/4.0/ref/settings/#email-use-ssl
EMAIL_USE_SSL=False
# See https://docs.djangoproject.com/en/4.0/ref/settings/#email-timeout
EMAIL_TIMEOUT=
DEFAULT_FROM_EMAIL=

# Api Key to sent emails via SendGrid if Debug=False (optional).
# If you use the SENDGRID_API_KEY you must also set EMAIL_BACKEND=sendgrid_backend.SendgridBackend
SENDGRID_API_KEY=

# Set Google Analytics or keep empty (optional).
GOOGLE_ANALYTICS=

# Captcha protected signup (optional).
CAPTCHA=False

# Flower URL or keep empty (optional).
FLOWER_URL=

# Rate limit per worker (optional).
TASK_DEFAULT_RATE_LIMIT=30/m

# Configure Azure OCR (optional).
AZURE_OCR_KEY=
AZURE_OCR_VERSION=
AZURE_OCR_BASE_URL=

# If this is activated SSL is required (optional).
# See https://docs.djangoproject.com/en/4.0/ref/settings/#std:setting-SESSION_COOKIE_SECURE
SESSION_COOKIE_SECURE=True

# If this is activated SSL is required (optional).
# https://docs.djangoproject.com/en/4.0/ref/settings/#csrf-cookie-secure
CSRF_COOKIE_SECURE=True

# New relic settings (optional).
NEW_RELIC_LICENSE_KEY=
NEW_RELIC_APP_NAME=
NEW_RELIC_ENVIRONMENT=

# Directory to cache files during the AI training process and when running AI models (optional).
KONFUZIO_CACHE_DIR =   # e.g. &#39;/cache&#39;, uses tempdir if not set

# KEYCLOAK ENVIRONMENT The following values establish a keycloak connection through the
# mozilla oidc package (https://mozilla-django-oidc.readthedocs.io/en/stable/settings.html) (optional).

# SET TO TRUE TO ACTIVATE KEYCLOAK (optional).
SSO_ENABLED=True

# If you use keycloak version 17 and later set url like: http(s)://{keycloak_address}:{port}/ (optional).
# If you use keycloak version 16 and earlier set url like: http(s)://{keycloak_address}:{port}/auth/ (optional).
KEYCLOAK_URL=
KEYCLOAK_REALM=  # defaults to master

For Keycloak client creation see: https://www.keycloak.org/docs/latest/server_admin/#assembly-managing-clients_server_administration_guide (optional).
OIDC_RP_SIGN_ALGO=RS256
OIDC_RP_CLIENT_ID=
OIDC_RP_CLIENT_SECRET=

# These variables are only used for Keycloak integration tests:
# The admin variables are for login keycloak admin panel, the test variables are for login to Konfuzio server (optional).
KEYCLOAK_ADMIN_USERNAME=
KEYCLOAK_ADMIN_PASSWORD=
KEYCLOAK_TEST_USERNAME=
KEYCLOAK_TEST_PASSWORD=

# Turn on/off autoretraining (optional).
TRAIN_EXTRACTION_AI_AUTOMATICALLY_IF_QUEUE_IS_EMPTY=False

# Turn on/off the immediate generation of sandwich pdf in full document workflow (optional).
ALWAYS_GENERATE_SANDWICH_PDF=True

# Default time limits for background tasks (optional).
EXTRACTION_TIME_LIMIT =
CATEGORIZATION_TIME_LIMIT =
EVALUATION_TIME_LIMIT =
TRAINING_EXTRACTION_TIME_LIMIT =
TRAINING_CATEGORIZATION_TIME_LIMIT =
SANDWICH_PDF_TIME_LIMIT =
DOCUMENT_TEXT_AND_BBOXES_TIME_LIMIT =
</pre></div>
</div>
</section>
<section id="environment-variables-for-read-api-container">
<h3>Environment Variables for Read API Container<a class="headerlink" href="#environment-variables-for-read-api-container" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> # The Azure OCR API key (mandatory).
AZURE_OCR_KEY=123456789
 # The URL of the READ API (mandatory).
AZURE_OCR_BASE_URL=http://host:5000
# The version of the READ API (optional).
AZURE_OCR_VERSION=v3.2
</pre></div>
</div>
</section>
<section id="environment-variables-for-detectron-container">
<h3>Environment Variables for Detectron Container<a class="headerlink" href="#environment-variables-for-detectron-container" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># Connect Broker (mandatory).
BROKER_URL=
# Connect result backend (mandatory).
RESULT_BACKEND=
# Decide if GPU used (True/False) (mandatory).
GPU=
# Allow root (mandatory).
C_FORCE_ROOT=True
# Connect Sentry (optional).
SENTRY_ENVIRONMENT=
SENTRY_RELEASE=
# Setting for task processing (optional).
WORKER_SEND_TASK_EVENTS=
TASK_SEND_SENT_EVENT=
TASK_TRACK_STARTED=
TASK_ACKS_ON_FAILURE_OR_TIMEOUT=
TASK_ACKS_LATE=
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="frontend/index.html" class="btn btn-neutral float-left" title="Frontend" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="changelog_app.html" class="btn btn-neutral float-right" title="Changelog" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Helm und Nagel GmbH.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D02B3QF8Z3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-D02B3QF8Z3');
</script>
<script src="https://cmp.osano.com/16CVyMSbk3Iar1G3f/97ee6223-b0cb-4f8c-abd6-a25a0d6f6507/osano.js"></script>


</body>
</html>